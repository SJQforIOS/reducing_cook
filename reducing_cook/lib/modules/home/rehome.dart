import 'package:ecook/common/color_helper.dart';import 'package:ecook/common/https/http_helper.dart';import 'package:ecook/common/reroute.dart';import 'package:ecook/common/screen_info_helper.dart';import 'package:ecook/model/menu_detail_model.dart';import 'package:flutter/material.dart';class HomeVC extends StatefulWidget {  @override  _HomeVCState createState() => new _HomeVCState();}class _HomeVCState extends State<HomeVC> {  List<Map> subTitleList = [    {"title":"减脂健身","icon":"assets/home_js.png"},    {"title":"美容养颜","icon":"assets/home_my.png"},    {"title":"营养素食","icon":"assets/home_ss.png"},  ];  List<Map> _detailList = [    {"title":"美味营养成功率高的一道家常菜","icon":"assets/home_pic1.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"小乔2","isCollection":false,"collectionNum":30},    {"title":"手残党也能做出的美味","icon":"assets/home_pic2.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"小乔3","isCollection":false,"collectionNum":20},    {"title":"干锅花菜","icon":"assets/home_pic3.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"小黄","isCollection":false,"collectionNum":33},    {"title":"干锅土豆","icon":"assets/home_pic1.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"小绿","isCollection":false,"collectionNum":5},    {"title":"藤椒鱼","icon":"assets/home_pic2.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"小橙","isCollection":false,"collectionNum":230},    {"title":"干锅牛蛙","icon":"assets/home_pic3.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"乔峰","isCollection":false,"collectionNum":3430},    {"title":"麻辣小龙虾","icon":"assets/home_pic2.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"段誉","isCollection":false,"collectionNum":50},    {"title":"这个夏天可乐和小龙虾更配哦~","icon":"assets/home_pic3.png","userIcon":"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1591437650046&di=4100ed6fa7868397efdb6d372d1e9bfb&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201509%2F22%2F20150922180033_hV43u.jpeg","name":"军刀","isCollection":false,"collectionNum":3},  ];  List<ListBean> _dataList = [];  void _loadHomeListData() async{    BaseHttpResponse response = await httpRequest.getRequest(GetContentsBySubClassId, data: {"id":"257352874", "page":'0', "version":"15.0"});    _dataList = HomeBean.fromMap(response.responseJson).list;    setState(() {    });  }  @override  void initState() {    // TODO: implement initState    _loadHomeListData();    super.initState();  }  void _clickCollectionBtn(String title) {    setState(() {      //先找到数组中对应的那一行数据//      for (int i = 0 ; i < _detailList.length ; i++) {//        Map obj = _detailList[i];//        bool isClick = obj["isCollection"];//        int collectionNum = obj["collectionNum"];//        if (obj["title"] == title) {//          obj["isCollection"] = !isClick;//          if (obj["isCollection"]) {//            collectionNum++;//          } else {//            collectionNum--;//          }//          obj["collectionNum"] = collectionNum;////          _detailList.removeAt(i);//          _detailList.insert(i, obj);//          return ;//        }//      }    });  }  @override  Widget build(BuildContext context) {    return Column(      children: <Widget>[        Container(          margin: EdgeInsets.fromLTRB(20, 44, 20, 0),          width: MediaQuery.of(context).size.width-40,          height: 44,          child: FlatButton.icon(            onPressed: (){              ReRoute.presentToSearchVC(context);            },            label: Text("搜索菜谱/食材"),            textColor: Color(0xFFC2BFCF),            color: Color(0xFFdddddd),            icon: Icon(Icons.search),            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(22)),          ),        ),       Expanded(         child:  Container(           /// 思考使用 CustomScrollView 实现           child: ListView.builder(itemBuilder: (BuildContext context, int index) {             if(index == 0) {               return HomeFunctionCell();             } else {               if (_dataList.length > 0) {                 ListBean listBean = _dataList[index-1];                 return HomeEcookCell(                   title: listBean.name,                   icon: listBean.imageid,                   userIcon: listBean.user.imageid,                   name: listBean.user.nickname,                   isCollection: _detailList[index-1]["isCollection"],                   collectionNum:  listBean.infos.collectionCount,                   onClickCollection: (title){                     _clickCollectionBtn(title);                   },                   clickCookDetail: (title){                     //打开详情                     ReRoute.presentToEcookDetailVC(context, listBean.id);                   },                 );               } else {                 return Container();               }             }           },             itemCount: _detailList.length+1,             padding: EdgeInsets.fromLTRB(20, 0, 20, 0),),         ),       ),      ],    );  }}//功能cell样式class HomeFunctionCell extends StatelessWidget {  @override  Widget build(BuildContext context) {    return Container(      width: REScreenInfo.screenWidth-40,      height: 112,      margin: EdgeInsets.fromLTRB(18, 0, 18, 0),      decoration: BoxDecoration(//        color: ColorHelper.slRandomColor(),      ),      child: CustomScrollView(          slivers: <Widget>[            SliverPadding(              padding: EdgeInsets.fromLTRB(0, 24, 0, 0),              sliver: SliverGrid(                  gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(                    crossAxisCount: 3,      //每行个数                    mainAxisSpacing: 10,    //垂直间距                    crossAxisSpacing: 75*REScreenInfo.screenWidthRatio,   //水平间距                    childAspectRatio: 0.7,  //宽高比                  ),                  delegate: SliverChildBuilderDelegate((BuildContext context, int index) {                    return HomeFunctionItem(                        title: _HomeVCState().subTitleList[index]["title"],                        icon: _HomeVCState().subTitleList[index]["icon"],                        onClicked: (){                          //点击事件                        });                  },                    childCount: _HomeVCState().subTitleList.length,                  )              ),            ),          ],      ),    );  }}class HomeFunctionItem extends StatelessWidget {  HomeFunctionItem({Key key, this.icon, this.title, this.onClicked}) : super(key:key);  final String icon;  final String title;  final VoidCallback onClicked;  @override  Widget build(BuildContext context) {    // TODO: implement build    return GestureDetector(      onTap: (){        onClicked();      },      child: Container(        decoration: BoxDecoration(//          color: ColorHelper.slRandomColor(),        ),        child: Column(          mainAxisAlignment: MainAxisAlignment.spaceBetween,          children: <Widget>[            Image(              image: AssetImage(icon),              fit: BoxFit.cover,              height: 50,              width: 50,            ),            Text(title, style: TextStyle(                fontSize: 12,                color: Color(0xFF84838B)            ),)          ],        ),      ),    );  }}//菜谱cell样式class HomeEcookCell extends StatelessWidget {  final String icon;  final String title;  final String userIcon;  final String name;  final bool isNetData;  final bool isCollection;  final int collectionNum;  final Function(String title) onClickCollection;  final Function(String title) clickCookDetail;  HomeEcookCell({Key key, @required this.icon, this.title, this.userIcon, this.isNetData, this.name, this.isCollection, this.collectionNum, this.onClickCollection, this.clickCookDetail}) : assert( icon != null), super(key:key);  @override  Widget build(BuildContext context) {    final ecookIconImageWidth = REScreenInfo.screenWidth-40;    return GestureDetector(      child: Container(        width: ecookIconImageWidth,        height: ecookIconImageWidth,        margin: EdgeInsets.fromLTRB(0, 8, 0, 8),        child: Stack(          fit: StackFit.loose,          children: <Widget>[            ClipRRect(              borderRadius: BorderRadius.circular(16),              child: getNetImageWithId(icon, size: Size.square(ecookIconImageWidth)),            ),            Positioned(              left: 0,              top: 0,              right: 0,              height: 110,              child: Container(                decoration: BoxDecoration(                    color: ColorHelper.hexStringToColor("#000000",alpha: 0.2)                ),              ),            ),            Positioned(              left: 20,              top: 24,              right: 20,              child: Text(title,style: TextStyle(                fontSize: 22,                color: Colors.white,                fontWeight: FontWeight.bold,              ), maxLines: 1),            ),            Positioned(              left: 20,              top: 64,              child: ClipRRect(                borderRadius: BorderRadius.circular(14),                child: SizedBox(                  child: getNetImageWithId(userIcon, size: Size.square(28)),                  width: 28,                  height: 28,                ),              ),            ),            Positioned(              left: 56,              top: 70,              right: 20,              child: Text(name,style: TextStyle(                  fontSize: 12,                  color: Colors.white              ),),            ),            Positioned(              right: 20,              bottom: 24,              width: 44,              height: 44,              child: ClipRRect(                borderRadius: BorderRadius.circular(22),                child: FlatButton(                  padding: EdgeInsets.all(0),                  onPressed: (){                    onClickCollection(title);                  },                  splashColor: Color(0x00000000),                  color: Color(0xB0F5F5F7),                  child: Column(                    mainAxisAlignment: MainAxisAlignment.center,                    children: <Widget>[                      Image(                        image: AssetImage(isCollection ? "assets/home_tab_sc.png" : "assets/zj_zan_def.png"),                        fit: BoxFit.cover,                        height: 20,                        width: 20,                      ),                      Text("$collectionNum", style: TextStyle(                          fontSize: 8,                          color: Color(0xFF84838B)                      ),maxLines: 1,                      )                    ],                  ),                ),              ),            ),          ],        ),      ),      onTap: (){        clickCookDetail(title);      },    );  }}